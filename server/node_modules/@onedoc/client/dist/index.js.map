{"version":3,"sources":["../src/index.ts","../src/htmlBuilder.ts","../src/client.ts"],"sourcesContent":["export { Onedoc } from \"./client\";\nexport { HtmlBuilder } from \"./htmlBuilder\";\n","export class HtmlBuilder {\n  private title?: string;\n  private start: string = `<!DOCTYPE html>\n                             <html  lang=\"en\">\n                                <head>\n                                    <meta charset = \"UTF-8\">\n                                    <meta name=\"viewport\" content=\"width=device-width\">`;\n  private middle: string = `\n                                </head>\n                                <body>`;\n\n  private end: string = `</body>\n                        </html>`;\n\n  private watermark: string = `<div id=\"watermark-onedoc\" > <a href=\"https://www.onedoclabs.com/\" target=\"_blank\"> <svg style=\"transform: rotate(90deg);display:inline;margin-top:30px;\" width=75 xmlns=\"http://www.w3.org/2000/svg\" x=\"0\" y=\"0\" enableBackground=\"new 0 0 46.15 9.31\" version=\"1.1\" viewBox=\"0 0 46.15 9.31\" xmlSpace=\"preserve\" fill=\"black\" {...props} > <path d=\"M10 9.13V2.55h1.83v.91c.35-.62 1.13-1.09 2.07-1.09.71 0 1.32.24 1.81.71s.74 1.15.74 2.03v4.02h-1.88V5.6c0-.96-.5-1.5-1.28-1.5-.85 0-1.42.62-1.42 1.55v3.48H10zM23.84 6.48h-4.83c.23.83.83 1.24 1.79 1.24.74 0 1.43-.22 2.05-.64l.74 1.28c-.8.61-1.76.91-2.88.91-1.16 0-2.05-.34-2.67-1-.61-.66-.92-1.47-.92-2.45 0-1 .32-1.81.96-2.46.64-.66 1.48-.98 2.51-.98.97 0 1.76.3 2.39.89.62.59.94 1.39.94 2.41-.01.23-.04.5-.08.8zM19 5.13h3.09c-.18-.76-.73-1.22-1.51-1.22-.76 0-1.38.46-1.58 1.22zM29.43 0h1.88v9.13h-1.82v-.71c-.52.59-1.16.88-1.96.88-.92 0-1.69-.32-2.31-.98-.61-.66-.92-1.47-.92-2.47 0-.98.31-1.8.92-2.46.62-.66 1.39-1 2.31-1 .74 0 1.38.26 1.89.8V0zm-.39 4.6c-.31-.34-.71-.5-1.2-.5s-.89.17-1.21.5c-.31.34-.47.74-.47 1.22 0 .49.16.91.47 1.25.32.34.72.5 1.21.5s.89-.17 1.2-.5c.32-.34.48-.76.48-1.25 0-.47-.15-.88-.48-1.22zM33.03 8.31c-.66-.67-.98-1.5-.98-2.47s.32-1.8.98-2.46c.66-.67 1.51-1.01 2.55-1.01 1.04 0 1.91.34 2.57 1.01.66.66 1 1.49 1 2.46s-.34 1.8-1 2.47c-.66.66-1.52 1-2.57 1-1.04 0-1.89-.34-2.55-1zm3.74-3.68c-.32-.34-.72-.5-1.19-.5s-.86.17-1.19.5c-.32.32-.48.73-.48 1.2 0 .49.16.9.48 1.24.32.32.72.49 1.19.49s.86-.17 1.19-.49c.32-.34.49-.74.49-1.24 0-.47-.17-.88-.49-1.2zM40.5 8.31c-.65-.65-.97-1.47-.97-2.48s.32-1.83.98-2.47c.66-.65 1.5-.97 2.54-.97 1.36 0 2.55.67 3.09 1.87l-1.5.8c-.38-.62-.9-.94-1.56-.94-.49 0-.89.17-1.21.49-.32.32-.48.73-.48 1.21 0 .49.16.91.47 1.24.32.32.72.48 1.2.48.66 0 1.27-.38 1.55-.92l1.52.9c-.58 1.07-1.74 1.75-3.12 1.75-1.02 0-1.86-.32-2.51-.96zM9.26 4.7c0-1.29-.44-2.36-1.34-3.25C7.03.55 5.94.1 4.63.1c-1.3 0-2.39.45-3.29 1.35C.45 2.34 0 3.43 0 4.71c0 .37.05.72.12 1.05l4.3-3.39h2.22v6.46c.47-.22.9-.5 1.29-.88.89-.89 1.33-1.97 1.33-3.25z\"></path> <path d=\"M1.49 8.09c.62.56 1.34.94 2.17 1.1v-2.8l-2.17 1.7z\"></path> </svg> <a /> </div>`;\n\n  constructor(title?: string) {\n    this.title = title;\n  }\n\n  build(document: string, styleSheets?: string[], dev = true) {\n    if (styleSheets) {\n      styleSheets.forEach((path) => {\n        this.start += `<link rel = \"stylesheet\" href=${path} />`;\n      });\n    }\n\n    if (this.title) {\n      this.start += `<title>${this.title}</title>`;\n    }\n\n    this.middle += document;\n\n    if (dev == true) {\n      // adds watermak for dev renderings\n\n      this.start += `<style>\n                      @page {\n\n                        @left-middle {\n                          content: flow(watermark);\n                        }\n                      }\n                      #watermark-onedoc { -prince-flow: static(watermark, start) }\n\n                    </style>`;\n\n      this.middle += this.watermark;\n    }\n    return this.start + this.middle + this.end;\n  }\n}\n","import { HtmlBuilder } from \"./htmlBuilder\";\nexport interface PathString {\n  path: string;\n  content: string;\n}\nexport interface PathBuffer {\n  path: string;\n  content: Buffer;\n}\n\nexport interface ExternalLink {\n  href: string;\n}\nexport interface DocumentInput {\n  html: string;\n  title?: string;\n  test?: boolean;\n  assets?: PathString[] | PathBuffer[];\n  save?: boolean;\n  /**\n   * Number of seconds to cache the file in the CDN for.\n   */\n  expiresIn?: number;\n  //| ExternalLink\n}\n\nconst DEFAULT_FILE_OPTIONS: any = {\n  cacheControl: \"3600\",\n  contentType: \"text/plain;charset=UTF-8\",\n  upsert: false,\n};\n\ntype FileBody =\n  | ArrayBuffer\n  | ArrayBufferView\n  | Blob\n  | File\n  | FormData\n  | ReadableStream<Uint8Array>\n  | URLSearchParams\n  | string;\n\n//https://www.npmjs.com/package/@supabase/storage-js?activeTab=code\nasync function uploadToSignedUrl(\n  urlToFS: string,\n  path: string,\n  token: string,\n  fileBody: FileBody,\n  fileOptions?: any\n) {\n  const url = new URL(urlToFS + `/object/upload/sign/${path}`);\n  url.searchParams.set(\"token\", token);\n\n  try {\n    let body;\n    const options = { upsert: DEFAULT_FILE_OPTIONS.upsert, ...fileOptions };\n    const headers: Record<string, string> = {\n      ...{ \"x-upsert\": String(options.upsert as boolean) },\n    };\n\n    if (typeof Blob !== \"undefined\" && fileBody instanceof Blob) {\n      body = new FormData();\n      body.append(\"cacheControl\", options.cacheControl as string);\n      body.append(\"\", fileBody);\n    } else if (\n      typeof FormData !== \"undefined\" &&\n      fileBody instanceof FormData\n    ) {\n      body = fileBody;\n      body.append(\"cacheControl\", options.cacheControl as string);\n    } else {\n      body = fileBody;\n      headers[\"cache-control\"] = `max-age=${options.cacheControl}`;\n      headers[\"content-type\"] = options.contentType as string;\n    }\n\n    const res = await fetch(url.toString(), {\n      method: \"PUT\",\n      body: body as BodyInit,\n      headers,\n    });\n\n    const data = await res.json();\n\n    if (res.ok) {\n      return {\n        data: { path: path, fullPath: data.Key },\n        error: null,\n      };\n    } else {\n      const error = data;\n      return { data: null, error };\n    }\n  } catch (error) {\n    throw error;\n  }\n}\n\nexport class Onedoc {\n  private apiKey: string;\n  private endpoint: string = \"https://app.onedoclabs.com\";\n\n  constructor(apiKey: string) {\n    this.apiKey = apiKey;\n  }\n\n  private buildUrl(path: string) {\n    return `${this.endpoint}${path}`;\n  }\n\n  async render(document: DocumentInput) {\n    const assets = [\n      ...(document.assets || []),\n      {\n        path: \"/index.html\",\n        content: document.html,\n      },\n    ];\n\n    const test: boolean = document.test === undefined ? true : document.test;\n    const save: boolean = document.save === undefined ? false : document.save;\n    const expiresIn: number = document.expiresIn ? document.expiresIn : 1;\n\n    // Fetch the /api/docs/initiate API endpoint\n    const information = await fetch(this.buildUrl(\"/api/docs/initiate\"), {\n      method: \"POST\",\n      headers: {\n        \"x-api-Key\": this.apiKey,\n        \"Content-Type\": \"application/json\", // Set Content-Type if you are sending JSON data\n      },\n      body: JSON.stringify({\n        assets,\n      }),\n    });\n\n    if (information.status !== 200) {\n      return {\n        file: null,\n        error: ((await information.json()).error ||\n          \"An unknown error has occurred\") as string,\n        info: {\n          status: information.status,\n        },\n      };\n    }\n\n    // Show the response body\n    const response = await information.json();\n\n    //--------------- UPLOAD FILES IN ASSETS ---------------\n\n    const signedURLs = response.signedUrls;\n\n    signedURLs.forEach(async (e) => {\n      const asset = document.assets?.find((item) => {\n        return item.path == e.path;\n      });\n\n      if (asset?.content) {\n        await uploadToSignedUrl(e.signedUrl, e.path, e.token, asset.content);\n      } else if (e.path == \"/index.html\") {\n        let htmlBuilder = new HtmlBuilder(document.title);\n\n        const styleSheets = document.assets\n          ?.filter((asset) => asset.path.includes(\".css\"))\n          .map((asset) => asset.path);\n\n        const html: string = htmlBuilder.build(\n          document.html,\n          styleSheets,\n          test\n        );\n\n        await uploadToSignedUrl(e.signedUrl, e.path, e.token, html);\n      }\n    });\n\n    console.log(response);\n\n    const doc = await fetch(this.buildUrl(\"/api/docs/generate\"), {\n      method: \"POST\",\n      headers: {\n        \"x-api-key\": this.apiKey,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        ...response,\n        title: document.title || \"document\",\n        test: test,\n        save: save,\n        expiresIn: expiresIn,\n      }),\n    });\n\n    // If status is not 200, it means there is an error\n    if (doc.status !== 200) {\n      return {\n        file: null,\n        link: null,\n        error: ((await doc.json()).error ||\n          \"An unknown error has occurred\") as string,\n        info: {},\n      };\n    }\n\n    if (!save) {\n      return {\n        file: await doc.arrayBuffer(),\n        link: null,\n        error: null,\n        info: {},\n      };\n    }\n    {\n      return {\n        file: null,\n        link: (await doc.json()).url_link,\n        error: null,\n        info: {},\n      };\n    }\n  }\n}\n\n/**\n *         \"raw\": \"{\\\"statusCode\\\":500,\\\"error\\\":\\\"internal\\\",\\\"originalError\\\":{\\\"length\\\":135,\\\"name\\\":\\\"error\\\",\\\"severity\\\":\\\"ERROR\\\",\\\"code\\\":\\\"22P02\\\",\\\"file\\\":\\\"uuid.c\\\",\\\"line\\\":\\\"133\\\",\\\"routine\\\":\\\"string_to_uuid\\\"},\\\"details\\\":\\\"insert into \\\\\\\"objects\\\\\\\" (\\\\\\\"bucket_id\\\\\\\", \\\\\\\"metadata\\\\\\\", \\\\\\\"name\\\\\\\", \\\\\\\"owner\\\\\\\", \\\\\\\"owner_id\\\\\\\", \\\\\\\"version\\\\\\\") values ($1, DEFAULT, $2, DEFAULT, DEFAULT, $3) - invalid input syntax for type uuid: \\\\\\\"pdf-70924304-2a67-4f75-99de-7e53bdbd7251\\\\\\\"\\\"}\",\n\n */\n\n/** allow_owned_buckets\n * ( SELECT (EXISTS ( SELECT 1\n           FROM buckets\n          WHERE ((buckets.id = (objects.bucket_id)::uuid) AND (buckets.api_key_id = (((current_setting('request.headers'::text, true))::json ->> 'x-api-key'::text))::uuid)))) AS \"exists\")\n */\n"],"mappings":"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","names":["asset"]}